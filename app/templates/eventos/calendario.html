{% extends 'base.html' %}

{% block title %}Calendário: {{ calendario.nome }}{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<style>
    #calendario {
        height: 700px;
        margin-bottom: 1rem;
    }

    .evento-tooltip {
        max-width: 300px;
        padding: 10px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .fc-event {
        cursor: pointer;
    }

    /* Estilo para os eventos do calendário */
    .fc-daygrid-event {
        white-space: normal !important;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 2px 4px !important;
        font-size: 0.85em;
        line-height: 1.3;
    }

    /* Limitar altura dos eventos */
    .fc-daygrid-event-harness {
        max-height: 40px;
    }

    /* Melhora a visualização de eventos em dias pequenos */
    .fc-daygrid-day-events {
        padding: 0 !important;
    }

    .fc-daygrid-day-number {
        font-weight: bold;
    }

    /* Estilização da legenda */
    .legenda-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .legenda-cor {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        margin-right: 8px;
        flex-shrink: 0;
    }

    .periodo-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .periodo-titulo {
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
    }

    /* Estilização da contagem de dias */
    .categoria-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .dias-validos {
        font-size: 0.85em;
        color: #6c757d;
        background-color: #f8f9fa;
        padding: 2px 5px;
        border-radius: 3px;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ calendario.nome }} ({{ calendario.ano }})</h2>
    <div>
        <a href="{{ url_for('evento.relatorio_calendario', id=calendario.id_calendario) }}" class="btn btn-info mr-2">
            <i class="fas fa-file-alt"></i> Relatório Detalhado
        </a>
        <a href="{{ url_for('calendario.listar') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-9">
        <div class="card mb-4">
            <div class="card-body">
                <div id="calendario"></div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Legenda</h5>
            </div>
            <div class="card-body">
                <!-- Organizar categorias por período -->
                {% set periodos_dict = {} %}
                {% set categoria_eventos = {} %}

                <!-- Contagem de eventos por categoria para estatísticas -->
                {% for evento in eventos %}
                {% if evento.categoria_nome in categoria_eventos %}
                {% set _ = categoria_eventos.update({evento.categoria_nome: categoria_eventos[evento.categoria_nome] +
                1}) %}
                {% else %}
                {% set _ = categoria_eventos.update({evento.categoria_nome: 1}) %}
                {% endif %}
                {% endfor %}

                {% for categoria in calendario.categorias %}
                {% if categoria.periodo.id_periodo not in periodos_dict %}
                {% set _ = periodos_dict.update({categoria.periodo.id_periodo: {'nome': categoria.periodo.descricao,
                'categorias': []}}) %}
                {% endif %}
                {% set _ = periodos_dict[categoria.periodo.id_periodo]['categorias'].append(categoria) %}
                {% endfor %}

                <!-- Exibir categorias separadas por período -->
                {% for periodo_id, periodo_info in periodos_dict.items() %}
                <div class="periodo-section">
                    <div class="periodo-titulo">{{ periodo_info.nome }}</div>
                    {% for categoria in periodo_info.categorias %}
                    <div class="legenda-item">
                        <div class="categoria-info">
                            <div style="display: flex; align-items: center;">
                                <div class="legenda-cor" style="background-color: {{ categoria.corassociada }};"></div>
                                <span>{{ categoria.nome }}</span>
                            </div>

                            {% if categoria.habilitacaocontagem %}
                            <div class="dias-validos">
                                {{ contagem_dias_por_categoria.get(categoria.id_categoria, 0) }}/{{ categoria.totaldias }} dias
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Estatísticas</h5>
            </div>
            <div class="card-body">
                <p><strong>Total de Eventos:</strong> {{ eventos|length }}</p>

                <p><strong>Distribuição por Categoria:</strong></p>
                <ul class="list-group list-group-flush">
                    {% for nome, contagem in categoria_eventos.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                        {{ nome }}
                        <span class="badge badge-primary badge-pill">{{ contagem }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal de detalhes do evento -->
<div class="modal fade" id="eventoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventoTitulo"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Data:</strong> <span id="eventoDatas"></span></p>
                <p id="eventoDescricaoContainer"><strong>Descrição:</strong> <span id="eventoDescricao"></span></p>
                <p id="eventoLocalContainer"><strong>Local:</strong> <span id="eventoLocal"></span></p>
                <p><strong>Categoria:</strong> <span id="eventoCategoria"></span></p>
                <p id="diasValidosContainer"><strong>Dias válidos:</strong> <span id="diasValidos"></span></p>
            </div>
            <div class="modal-footer">
                <a href="#" id="eventoEditarLink" class="btn btn-primary">Editar</a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/pt-br.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendario');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listMonth'
            },
            initialView: 'dayGridMonth',
            events: {{ eventos| tojson | safe }},
        eventClick: function (info) {
            document.getElementById('eventoTitulo').textContent = info.event.title;

            let dataInicio = new Date(info.event.start);
            let dataFim = info.event.end ? new Date(info.event.end) : dataInicio;

            // Formatação das datas
            let formatoData = { day: 'numeric', month: 'numeric', year: 'numeric' };
            let dataTexto;

            if (dataInicio.toDateString() === dataFim.toDateString()) {
                dataTexto = dataInicio.toLocaleDateString('pt-BR', formatoData);
            } else {
                dataTexto = dataInicio.toLocaleDateString('pt-BR', formatoData) +
                    ' a ' +
                    dataFim.toLocaleDateString('pt-BR', formatoData);
            }

            document.getElementById('eventoDatas').textContent = dataTexto;

            // Descrição
            const descricaoContainer = document.getElementById('eventoDescricaoContainer');
            const descricaoElement = document.getElementById('eventoDescricao');

            if (info.event.extendedProps.description) {
                descricaoElement.textContent = info.event.extendedProps.description;
                descricaoContainer.style.display = 'block';
            } else {
                descricaoContainer.style.display = 'none';
            }

            // Local
            const localContainer = document.getElementById('eventoLocalContainer');
            const localElement = document.getElementById('eventoLocal');

            if (info.event.extendedProps.location) {
                localElement.textContent = info.event.extendedProps.location;
                localContainer.style.display = 'block';
            } else {
                localContainer.style.display = 'none';
            }

            // Categoria
            const categoria = info.event.extendedProps.categoria_nome || "Não definida";
            document.getElementById('eventoCategoria').textContent = categoria;

            // Link de edição
            document.getElementById('eventoEditarLink').href = "/eventos/editar/" + info.event.id;

            $('#eventoModal').modal('show');
        }
        });

    calendar.render();
    });
</script>
{% endblock %}